# Amazon Alexa Skill Setup Guide

This guide walks you through creating an Amazon Alexa Skill in the Amazon Developer Console with OAuth2 credentials needed for the Home Assistant Alexa OAuth2 integration.

## Prerequisites

- ✅ Amazon Developer account (free to create)
- ✅ Home Assistant with Nabu Casa/Home Assistant Cloud enabled
- ✅ Echo Dot or other Alexa device
- ✅ Alexa OAuth2 integration installed in Home Assistant (via HACS)

## Step 1: Access Amazon Developer Console

1. **Go to Amazon Developer Console**:
   - URL: https://developer.amazon.com/dashboard
   - Login with your Amazon account (same account that manages your Alexa devices)

2. **Accept Terms** (if first time):
   - Accept Developer terms and conditions
   - Complete any required registration

## Step 2: Create a New Alexa Skill

1. **Navigate to Alexa Skills Kit**:
   - From dashboard, click **Alexa Skills Kit** (or **Alexa** tab)
   - Click **"Create Skill"** button (top right)

2. **Fill in Skill Details**:
   - **Skill name**: `Home Assistant Alexa` (or your preferred name)
   - **Primary locale**: Select your region (e.g., `English (US)`)
   - **Choose model to add to your skill**: Select **"Smart Home"**
   - **Choose a method to host your skill's backend resources**:
     - Select **"Alexa-hosted (Python)"** (easiest)
     - Or **"Self-hosted"** if you prefer

3. **Click "Create Skill"**
   - Wait for skill to be created (1-2 minutes)

## Step 3: Configure Account Linking / OAuth2

This is the critical step that generates your Client ID and Client Secret.

### Option A: Account Linking (Recommended for Most Users)

1. **In your skill dashboard, go to "Build" tab**

2. **Left sidebar → Navigate to "Account Linking"** (or "Tools" → "Account Linking")

3. **Enable Account Linking**:
   - Toggle "Do you allow users to link accounts?" to **ON**

4. **Fill in Authorization URI**:
   - **Authorization URI**: `https://www.amazon.com/ap/oa`

5. **Fill in Access Token URI**:
   - **Access Token URI**: `https://api.amazon.com/auth/o2/token`

6. **Client ID and Client Secret** (Amazon will generate these):
   - **Client ID**: Copy this value - you'll need it for Home Assistant
   - **Client Secret**: Copy this value - you'll need it for Home Assistant
   - ⚠️ **IMPORTANT**: Save both values in a safe place!

7. **Redirect URLs** (MOST CRITICAL):
   - **Redirect URL 1**:
     ```
     https://my.home-assistant.io/redirect/alexa
     ```
   - ⚠️ **MUST MATCH EXACTLY**: This tells Amazon where to send the OAuth callback

8. **Scope** (Permissions):
   - Add scope: `alexa::skills:account_linking`
   - This gives the skill permission to access your account

9. **Click "Save"**
   - Amazon will validate your configuration

### Option B: OAuth2 Settings (Alternative)

If you see "OAuth2" instead of "Account Linking":

1. Navigate to **"OAuth2 Settings"**

2. Fill in the same information above:
   - Authorization URI: `https://www.amazon.com/ap/oa`
   - Access Token URI: `https://api.amazon.com/auth/o2/token`
   - Redirect URI: `https://my.home-assistant.io/redirect/alexa` ⚠️ **EXACT MATCH**
   - Client ID and Client Secret (auto-generated by Amazon)

3. **Save** the configuration

## Step 4: Get Your Client ID and Client Secret

After configuring Account Linking/OAuth2:

1. **Client ID Location**:
   - Should be displayed in Account Linking page
   - Format: starts with `amzn1.application-oa2-client.` followed by random characters
   - Example: `amzn1.application-oa2-client.abc123def456xyz789...`

2. **Client Secret Location**:
   - Displayed in Account Linking page
   - Long random string
   - Only shown once - save it immediately!
   - Cannot be recovered - if lost, you must regenerate

3. **Copy both values**:
   - ✅ **Client ID**: `amzn1.application-oa2-client....`
   - ✅ **Client Secret**: `long_random_string_here`

## Step 5: Activate the Skill

1. **Go to "Distribution" tab** (or "Publishing")

2. **Make sure skill is marked "In Development"**
   - You don't need to publish for testing

3. **Enable for testing**:
   - Toggle to enable the skill for your account only

## Step 6: Verify Configuration (Checklist)

Before moving to Home Assistant, verify:

| Item | Value | Status |
|------|-------|--------|
| Skill Name | Home Assistant Alexa | ☑️ |
| Model | Smart Home | ☑️ |
| Account Linking | Enabled | ☑️ |
| Authorization URI | `https://www.amazon.com/ap/oa` | ☑️ |
| Access Token URI | `https://api.amazon.com/auth/o2/token` | ☑️ |
| Redirect URI | `https://my.home-assistant.io/redirect/alexa` | ☑️ ⚠️ **EXACT MATCH** |
| Client ID | `amzn1.application-oa2-client.xxx...` | ☑️ |
| Client Secret | `long_random_string` | ☑️ |
| Scope | `alexa::skills:account_linking` | ☑️ |

## Step 7: Go to Home Assistant

Now that your Alexa Skill is configured:

1. **In Home Assistant**, go to:
   - **Settings** → **Devices & Services**

2. **Click "Create Integration"**

3. **Search for "Alexa OAuth2"**
   - Click on the result

4. **Enter your credentials**:
   - **Client ID**: Paste from Amazon (the `amzn1.application-oa2-client...` value)
   - **Client Secret**: Paste from Amazon (the long random string)

5. **Click "Submit"**
   - You'll be redirected to Amazon to login and authorize
   - Login with the Amazon account that has your Alexa devices
   - Authorize the skill

6. **Success!**
   - Config entry created in Home Assistant
   - Integration shows "Connected"
   - OAuth tokens are stored (encrypted)

## Troubleshooting

### "Invalid client_id format" Error in Home Assistant

**Problem**: The Client ID you entered doesn't match the expected format.

**Solution**:
1. Check that Client ID starts with `amzn1.application-oa2-client.`
2. Copy the FULL Client ID from Amazon (not just part of it)
3. Make sure no spaces or quotes were accidentally copied
4. Verify in Amazon Developer Console that the skill has Account Linking enabled

### "Redirect URI Mismatch" Error from Amazon

**Problem**: Amazon says the redirect URI doesn't match what was configured.

**Cause**: The redirect URI in your Home Assistant config doesn't match what you set in Amazon.

**Solution**:
1. **In Home Assistant**: The integration automatically uses:
   ```
   https://my.home-assistant.io/redirect/alexa
   ```
2. **In Amazon**: Make sure you set:
   ```
   https://my.home-assistant.io/redirect/alexa
   ```
3. **Case sensitive**: Exact match required - lowercase `alexa`, not `Alexa`

### "Client Secret Invalid" Error

**Problem**: Amazon rejects the Client Secret.

**Solution**:
1. Copy the full Client Secret from Amazon
2. Don't include any quotes or extra spaces
3. If lost, regenerate new credentials in Amazon Developer Console
4. The old Client Secret becomes invalid after regeneration

### "Authorization failed" / "Invalid code"

**Problem**: OAuth flow fails after you authorize on Amazon.

**Possible Causes**:
1. **Home Assistant not accessible from internet**:
   - Verify `my.home-assistant.io` works (test in browser)
   - Ensure Home Assistant Cloud/Nabu Casa is enabled and working
2. **Browser issue**:
   - Try different browser
   - Clear cookies and try again
3. **Redirect URI mismatch**:
   - Double-check Amazon skill has exact redirect URI
   - Verify in Home Assistant logs for specific error

## FAQ

**Q: Do I need to publish the skill to Amazon Appstore?**
A: No, you only need it "In Development" for testing with your account.

**Q: Can I use the same Alexa Skill for multiple Home Assistant instances?**
A: Yes, the skill is Amazon-side only. You can configure multiple HA instances with it (create multiple config entries).

**Q: What if I lose my Client Secret?**
A: You must generate new credentials in Amazon Developer Console. The old ones become invalid. Re-add the integration in Home Assistant with new credentials.

**Q: Why do I need Home Assistant Cloud (Nabu Casa)?**
A: Amazon must reach the `my.home-assistant.io/redirect/alexa` endpoint, which is only accessible via Home Assistant Cloud. Without it, the OAuth callback cannot reach your Home Assistant instance.

**Q: How long are the OAuth tokens valid?**
A: Typically 60-90 days for access tokens. The integration automatically refreshes them in the background before expiry.

**Q: What if authorization fails - will I have to redo all this?**
A: No, the integration has a "Reauth" feature that will automatically prompt you to re-authorize without re-creating the config entry.

## Support

If you encounter issues:

1. **Check Home Assistant logs**:
   - Settings → System → Logs
   - Filter for "alexa" or "oauth"
   - Share error messages

2. **Verify configuration**:
   - Go back to Amazon Developer Console
   - Check Account Linking settings match exactly

3. **Re-test redirect URI**:
   - Manually visit: `https://my.home-assistant.io/redirect/alexa`
   - Should show Home Assistant interface or redirect to HA
   - If error: check Home Assistant Cloud status

## Next Steps

After successful OAuth setup:

1. ✅ Credentials working
2. ⏳ Wait for automatic device discovery (5-10 minutes)
3. ✅ Echo Dot should appear in Home Assistant Devices
4. ✅ Control Alexa devices from Home Assistant

---

**Last Updated**: November 1, 2025
**Integration Version**: 0.1.0
